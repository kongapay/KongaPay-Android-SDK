# Making Payments using KongaPay payment token linked with a user's KongaPay account.

After a user successfully authorized a merchant's app for pre-approved payments,
a token is provided to the merchant (as in step 5b above).

This document covers how
to make payments on behalf of a user using the KongaPay Payment Token. This is
based on the assumption that the implementing merchant has KongaPay payment token
that is to be debited.

## 1. Generate OAuth 2.0 Access Token

All requests to KongaPay require an Access Token. To generate an Access Token, KongaPay
is to provide the merchant with both `Merchant ID` and `Client Secret`.

Definition of parameters:
  * `merchant_id` - Merchant Id provided by KongaPay. *String* (Maximum of 15 characters)
  * `client_secret` - Client secret provided by KongaPay. This should be kept securely
  by the merchant. *String* (Maximum of 30 characters)
  * `access_code` - Access code is generated by a `GET` request to the Auth sever.
  Access code is required to generate Access Token. It expires after 30 seconds.
  *String* (Maximum of 128 characters)
  * `refresh_token` - Refresh Token can be used to get a new Access Token after the
  expiration of the Access Token. It expires after 14 days. *String* (Maximum of 128 characters)


### OAuth 2.0 Authentication
This follows the standard OAuth 2.0 flow where:

1. Client requests an access code
2. KongaPay returns the access code on success of step 1 request
3. Client uses the access code to request access token
4. KongaPay returns the access token and refresh token on success of step 3 request
5. Client then uses the access token to request resources from the server.

**Base URL** for OAuth: https://staging-auth.kongapay.com/ for the sandbox environment,
and https://auth.kongapay.com/ for the live environment.

#### Step 1: To request for an access code
*URL*: `{{oauth_base_url}}/authorize?response_type=code&client_id={merchant_id}&state=alive`  
*Request Type*: `GET`

#### Step 2: Get a response from Step 1 above.
*Success Response*:
```json
{
  "status": "success",
  "data": {
    "code": "{access_code}"
  }
}
```

*Error Response*:
```json
{
  "error": "invalid_client",
  "error_description": "The client id supplied is invalid"
}
```

#### Step 3: Use access code to request access token
*URL*: `{{oauth_base_url}}/token`  
*Request Type*: `POST`  
*Parameters*:  
    1. grant_type = authorization_code  
    2. code = {access_code} (the code returned from Step II)  
    3. client_id = {merchant_id}  
    4. client_secret = {client_secret}  

#### Step 4: Get a response from Step 3 above.
*Success Response*:
```json
{
    "access_token": "{access_token}",
    "expires_in": 21600,
    "token_type": "Bearer",
    "scope": null,
    "refresh_token": "{refresh_token}"
}
```

*Error Response*
```json
{
  "error": "invalid_grant",
  "error_description": "Authorization code doesn't exist or is invalid for the client"
}
```

##### Using refresh token to get another get another access token
*URL*: `{{oauth_base_url}}/token`  
*Request Type*: `POST`  
*Parameters*:  Form-data post with the following parameters  
    1. grant_type = refresh_token
    2. refresh_token = "{refresh_token}" (the refresh token returned from step 2)
    3. client_id = "{merchant_id}"
    4. client_secret = "{client_id}"

##### Server returns another token
```json
{
  "access_token": "{access_token}",
  "expires_in": 21600,
  "token_type": "Bearer",
  "scope": null
}
```

##### NOTE: Token/code expiration
The access token expires after 6 hours. Once the access token expires, the refresh token can be used to request for another token which will last for another 6 hours. However, refresh token expires after 14 days. Once the refresh token expires, the client needs to request another access code which will kick-start the flow again from the beginning.  

Access code expires 30 secs after it was requested which means the access code must have been used to request a token within 30 secs.

Now that we have an access token, you can proceed to 2 as shown below:



**Base URL** for KongaPay: https://api-sandbox.kongapay.com/v3/ for sandbox environment and https://api.kongapay.com/v3/ for live environment

**Definition of parameters:**

  * `merchant_id` - Merchant Id provided by KongaPay. *String* (Maximum of 15 characters).
  * `access_token` - Access Token is required to make any request to KongaPay. It expires after 6 hours. *String* (Maximum of 128 characters).
  * `payment_reference` - Unique payment reference to be provided by the Merchant. *String* (Maximum of 32 characters).
  * `token` - Payment Token provided by KongaPay after successful linking of KongaPay account to Merchant’s account either via SDK or web. *String* (Maximum of 150 characters).
  * `amount` - Amount to be debited in Naira.Kobo. Example 2005.45 will be read as Two Thousand Naira Forty Five Kobo. *String* (Maximum of 10 characters).
  * `currency_code` - The Currency code of the transaction. Only Naira (566) accepted for now. *String* (Maximum of 3 characters).
  * `status` - Status of the transaction. Expected “success” or “error”.
  * `transaction_reference` - Transaction Reference supplied by KongaPay after a successful transaction. *String* (Maximum of 20 characters).
  * `error_message` - Error message sent back from KongaPay when an error occurs. *String* (Maximum of 1000 characters).
  * `error_code` - Error code sent back from KongaPay when an error occurs. *String* (Maximum of 5 characters).

## 2. Debiting a KongaPay Linked Account with Token
This allows Merchants to debit a linked KongaPay Account using the Payment Token provided by KongaPay.

Access Token from 1. above is required for this step.

*URL*: `{{kongapay_base_url}}/payments/wallet/merchant/{merchant_id}/pay?access_token={access_token}`  
*Request Type*: `POST`  
*Parameters*: Receives a JSON payload in the following format:  
```json
{
  "payment_reference": "{payment_reference}",
  "token": "{token}",
  "amount": "{amount}",
  "currency_code": "566"
}
```

*Success Response*:
```json
{
  "status": "success",
  "data": {
    "transaction_reference": "{transaction_reference}"
  }
}

```

*Error Response*:
```json
{
  "status": "error",
  "message": "{error_message}",
  "code": "{error_code}"
}
```

## 3. Requery a KongaPay Transaction
This allows Merchants to requery a KongaPay transaction using the payment_reference used in making payment.

Access Token from 1. above is required for this step.

*URL*: `{kongapay_base_url}/payments/{payment_reference}/merchant/{merchant_id}?access_token={access_token}`  *Request Type*: `GET`

*Success Response*
```json
{
  "status": "success",
  "data": {
    "payment_reference": "{payment_reference}",
    "amount": "{amount}",
    "transaction_status": "{transaction_status}",
    "currency_code": "566",
    "transaction_reference": "{transaction_reference}",
    "type": "incoming",
    "transaction_date": "2016-02-29 14:02:30"
  }
}
```
